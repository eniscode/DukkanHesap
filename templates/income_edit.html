{% extends 'base.html' %}
{% block content %}
<section class="card">
  <h2>Gelir Düzenle</h2>
  <form method="post" class="form-grid">
    <label>
      Tarih
      <input type="date" name="date" value="{{ inc.date }}" required>
    </label>

    <label>
      Kategori
      <select name="category" required>
        <option value="Ciro" {% if inc.category == 'Ciro' %}selected{% endif %}>Ciro</option>
        <option value="Ek Gelir" {% if inc.category == 'Ek Gelir' %}selected{% endif %}>Ek Gelir</option>
      </select>
    </label>

    <label>
      Tutar
      <input type="text" name="amount" id="edit_amount" value="{{ '%.2f'|format(inc.amount) }}" placeholder="1.234,56" required>
    </label>

    <label class="full">
      Açıklama
      <textarea name="description" rows="2">{{ inc.description or '' }}</textarea>
    </label>

    <div class="actions">
      <button type="submit">Güncelle</button>
      <a href="/incomes" style="margin-left:12px;">İptal</a>
    </div>
  </form>
</section>

<script>
  (function(){
    function formatTRCurrency(input) {
      let val = input.value.replace(/[^0-9,]/g, '');
      const parts = val.split(',');
      if(parts.length > 2) {
        val = parts.slice(0, -1).join('') + ',' + parts[parts.length - 1];
      }
      const [intPart, decPart] = val.split(',');
      if(intPart) {
        let formatted = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        input.value = decPart !== undefined ? formatted + ',' + decPart : formatted;
      } else {
        input.value = val;
      }
    }
    
    const amtInput = document.getElementById('edit_amount');
    if(amtInput) {
      // Yükleme sırasında formatla
      let val = amtInput.value.replace(/\./g, '').replace(/,/g, '.');
      if(!isNaN(val) && val !== '') {
        amtInput.value = parseFloat(val).toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      }
      
      // Yazarken gerçek zamanlı formatla
      amtInput.addEventListener('input', function(){
        formatTRCurrency(this);
      });
      
      // Blur'da da formatla
      amtInput.addEventListener('blur', function(){
        let v = this.value.replace(/\./g, '').replace(/,/g, '.');
        if(!isNaN(v) && v !== '') {
          this.value = parseFloat(v).toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
      });
    }
  })();
</script>
{% endblock %}
