{% extends 'base.html' %}
{% block content %}
<section class="card">
  <h2>Gider Girişi</h2>
  <form method="post" class="form-grid" id="expForm">
    <label>
      Tarih
      <input type="date" name="date" id="exp_date" value="{{ today }}" required>
    </label>

    <label>
      Gün
      <input type="text" id="exp_day" value="{{ today | tr_day }}" readonly>
    </label>

    <label>
      Gider Kalemi
      <select name="category" required>
        <option value="Yeşillik">Yeşillik</option>
        <option value="Faik">Faik</option>
        <option value="Market">Market</option>
        <option value="Malzeme">Malzeme</option>
        <option value="Maaş">Maaş</option>
        <option value="Vergi">Vergi</option>
        <option value="Sigorta">Sigorta</option>
        <option value="Ek Gider">Ek Gider</option>
      </select>
    </label>

    <label>
      Tutar
      <input type="text" step="0.01" name="amount" id="exp_amount" placeholder="1.234,56" required>
    </label>

    <label class="full">
      Açıklama
      <textarea name="description" rows="2" placeholder="Örn: lavaş, tedarikçi adı, not"></textarea>
    </label>

    <div class="actions">
      <button type="submit">Ekle</button>
    </div>
  </form>
</section>

<section class="card">
  <h3>Gider Listesi</h3>
  
  <!-- Ay Seçici -->
  <form method="get" class="form-grid" style="margin-bottom: 20px;">
    <label>
      Ay Seç
      <input type="month" name="month" value="{{ selected_month }}" onchange="this.form.submit()">
    </label>
    <div>
      {% if selected_month %}
        <a href="/expenses" class="btn" style="display:inline-block; padding:8px 16px; background:#ef4444; color:white; text-decoration:none; border-radius:4px;">Tümünü Göster</a>
      {% endif %}
    </div>
  </form>
  
  <!-- Toplam Tutar -->
  <div style="background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%); padding: 16px; border-radius: 8px; margin-bottom: 16px; color: white; font-size: 18px; font-weight: bold; text-align: center;">
    Toplam Gider: {{ total | tr_currency }} TL
  </div>
  
  <table class="table">
    <thead>
      <tr>
        <th>Tarih</th>
        <th>Gün</th>
        <th>Kategori</th>
        <th>Tutar</th>
        <th>Açıklama</th>
        <th>İşlem</th>
      </tr>
    </thead>
    <tbody>
      {% for i in items %}
        <tr>
          <td>{{ i.date | tr_short_date }}</td>
          <td>{{ i.date | tr_day }}</td>
          <td>{{ i.category or '-' }}</td>
          <td>{{ i.amount | tr_currency }}</td>
          <td>{{ i.description or '-' }}</td>
          <td>
            <a href="/expense/edit/{{ i.id }}" style="margin-right:8px;">Düzenle</a>
            <form method="post" action="/expense/delete/{{ i.id }}" style="display:inline;" onsubmit="return confirm('Silmek istediğinize emin misiniz?');">
              <button type="submit" class="btn-delete">Sil</button>
            </form>
          </td>
        </tr>
      {% endfor %}
      {% if not items %}
        <tr><td colspan="6" class="muted">Henüz kayıt yok.</td></tr>
      {% endif %}
    </tbody>
  </table>
</section>

<script>
  (function(){
    const days = ["PAZAR", "PAZARTESİ", "SALI", "ÇARŞAMBA", "PERŞEMBE", "CUMA", "CUMARTESİ"];
    const inpDate = document.getElementById('exp_date');
    const inpDay  = document.getElementById('exp_day');
    function syncDay(){
      const v = inpDate.value;
      if(!v){ inpDay.value = ''; return; }
      const d = new Date(v + 'T00:00:00');
      const dow = d.getDay();
      inpDay.value = days[dow];
    }
    inpDate.addEventListener('change', syncDay);
    syncDay();

    // Turkish currency formatting
    const amtInput = document.getElementById('exp_amount');
    if(amtInput) {
      amtInput.addEventListener('blur', function(){
        let val = this.value.replace(/\./g, '').replace(/,/g, '.');
        if(!isNaN(val) && val !== '') {
          let num = parseFloat(val);
          this.value = num.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
      });
    }
  })();
</script>

<script>
  (function(){
    function formatTRCurrency(input) {
      // Sadece rakamları ve virgülü tut
      let val = input.value.replace(/[^0-9,]/g, '');
      
      // Birden fazla virgül varsa son biri hariç sil
      const parts = val.split(',');
      if(parts.length > 2) {
        val = parts.slice(0, -1).join('') + ',' + parts[parts.length - 1];
      }
      
      // Virgülden önceki kısmı nokta ile biçimlendir (binde ayırıcısı)
      const [intPart, decPart] = val.split(',');
      if(intPart) {
        let formatted = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        input.value = decPart !== undefined ? formatted + ',' + decPart : formatted;
      } else {
        input.value = val;
      }
    }
    
    const amtInput = document.getElementById('exp_amount');
    if(amtInput) {
      amtInput.addEventListener('input', function(){
        formatTRCurrency(this);
      });
    }
  })();
</script>
{% endblock %}
